## 核心原则

目标：先实现cypher-GQL，在准确率不错的情况下，可以扩展Gremlin、SOARQL等任意图查询语言互转。

方式：其实，如果只从cypher-GQL这个角度考虑的话，使用纯Python跑起来，能够向准确率靠拢才是最重要的。之后的话，可以考虑使用LagnGraph搭建骨架，向任意查询语言方向迈进。

#### 阶段0（已完成）

准备数据，将opencypher仓库对应features文件夹下数据抽取并转换为jsonl文件（1617条数据）。

设计抽样转换脚本，每次抽样从不同类别形式的cypher随机中抽取3条（110条数据）。

#### 阶段1：快速开发进行验证

先用什么操作都不加的代码跑通一个完整的流程：[输入Cypher] -> [LLM转换Agent] -> [输出GQL]，不加验证、纠错，先看一下基座大模型的转换准确率。

预计应该不会很好（不然也不会有这个工作了^_^），然后针对性的提升准确率，需要看到底是基础语法错误、关键字丢失、还是转换后的语义直接变了等等的问题，然后针对性地设计提示词，再针对性地设计提升准确率的agent。

#### 阶段2：提升准确率

###### 2.1基础准确率测量

这一步可能稍微麻烦一点，需要人工判断转换是否准确，然后针对性地提升准确率。

###### 2.2提示词优化

先判断转换出错的那些到底是哪类问题，然后针对性地设计提示词，比如下方提示词设计（暂时是通用的）

```
你是一个专业的图查询语言转换器，请严格遵循以下规范将 Cypher 查询转换为 GQL 查询：

- 仅输出转换后的完整 GQL 查询语句，无任何其他解释或多余内容。
- 确保转换结果与原查询的语义完全一致。
- 保留所有 WHERE 条件、RETURN 字段、MATCH 模式不变，仅调整为 GQL 语法。
- 如果遇到 CALL，请转换为对应的 GQL USE 或类似结构。
- 严格使用英文标点。
```

###### 2.3示例注入

如果特定情况下的准确率不好，比如说多层嵌套（逻辑稍微复杂点的）可以考虑在提示词中注入标准实例进行转换示范，在提示词中追加如下内容（暂时是简单的实例）

```
以下是示例：

Cypher:
MATCH (n:Person) RETURN n.name
GQL:
MATCH (n:Person) RETURN n.name

Cypher:
CALL db.labels() YIELD label RETURN label
GQL:
USE db.labels YIELD label RETURN label
```

###### 2.4官方文档注入

需要参照转换准确率再进一步判断是否需要这一步，当然首选提示词，让LLM严格按照GQL（目标语言）的语法/关键字来进行转换，如果实在关键字等转换不准确，需要考虑将官方文档中的要求注入进去。

#### 阶段3：考虑多agent协作

阶段1和阶段2结合起来算是转换Agent（ConverAgent），考虑可以加入验证Agent（ValidateAgent）和自我纠错Agent（RetryAgent）。

###### 验证Agent（ValidateAgent）

主要作用是进行语法检查（括号匹配、关键字等）和语义检查（字段是否缺失、条件查询中条件是否完整等），需要输出错误转换对应的错误类型，具体实现方式仍在考量。

###### 自我纠错Agent（RetryAgent）

验证Agent判断转换后的语句是否正确，如果转换错误，需要流转到此Agent，然后根据错误重新构造Prompt+原Cypher，然后再交给ConvertAgent再次生成。

这一步限制重试次数（例如2次），防止死循环。